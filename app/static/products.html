<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Management</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"] {
            width: 100%;
        }
        button {
            margin: 2px;
        }
    </style>
</head>
<body>
    <h2>Products</h2>
    <button onclick="fetchProducts()">Refresh</button>
    <button onclick="showCreateForm()">Create Product</button>

    <div id="create-form" style="display:none; margin-top:20px;">
        <h3>Create Product</h3>
        <input type="text" id="new-sku" placeholder="SKU">
        <input type="text" id="new-name" placeholder="Name">
        <input type="text" id="new-description" placeholder="Description">
        <button onclick="createProduct()">Save</button>
        <button onclick="hideCreateForm()">Cancel</button>
    </div>

    <table id="products-table">
        <thead>
            <tr>
                <th>SKU</th>
                <th>Name</th>
                <th>Description</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background:white; padding:30px; border-radius:8px; width:400px; margin:100px auto; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
            <h3>Edit Product</h3>
            <label>SKU:</label>
            <input type="text" id="edit-sku" placeholder="SKU" disabled style="margin-bottom:10px; width:100%; padding:8px; box-sizing:border-box;">
            <label>Name:</label>
            <input type="text" id="edit-name" placeholder="Name" style="margin-bottom:10px; width:100%; padding:8px; box-sizing:border-box;">
            <label>Description:</label>
            <textarea id="edit-description" placeholder="Description" style="margin-bottom:10px; width:100%; padding:8px; box-sizing:border-box; height:80px;"></textarea>
            <label>Active:</label>
            <input type="checkbox" id="edit-active" style="margin-bottom:20px;">
            <div>
                <button onclick="saveProduct()" style="padding:8px 16px; margin-right:10px;">Save</button>
                <button onclick="closeEditModal()" style="padding:8px 16px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let editingProductId = null;

        async function fetchProducts() {
            const response = await fetch("/products/");
            const products = await response.json();
            const tbody = document.querySelector("#products-table tbody");
            tbody.innerHTML = "";

            products.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.sku}</td>
                    <td>${p.name || ""}</td>
                    <td>${p.description || ""}</td>
                    <td>${p.active ? "Yes" : "No"}</td>
                    <td>
                        <button onclick="openEditModal(${p.id}, '${p.sku}', '${(p.name || '').replace(/'/g, "\\'")}', '${(p.description || '').replace(/'/g, "\\'")}', ${p.active})">Edit</button>
                        <button onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openEditModal(id, sku, name, description, active) {
            editingProductId = id;
            document.getElementById("edit-sku").value = sku;
            document.getElementById("edit-name").value = name;
            document.getElementById("edit-description").value = description;
            document.getElementById("edit-active").checked = active;
            document.getElementById("edit-modal").style.display = "block";
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
            editingProductId = null;
        }

        async function saveProduct() {
            if (editingProductId === null) return;

            const name = document.getElementById("edit-name").value;
            const description = document.getElementById("edit-description").value;
            const active = document.getElementById("edit-active").checked;

            const response = await fetch(`/products/${editingProductId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, description, active })
            });

            if (response.ok) {
                alert("Product updated successfully!");
                closeEditModal();
                fetchProducts();
            } else {
                alert("Update failed.");
            }
        }

        function showCreateForm() {
            document.getElementById("create-form").style.display = "block";
        }

        function hideCreateForm() {
            document.getElementById("create-form").style.display = "none";
        }

        async function createProduct() {
            const sku = document.getElementById("new-sku").value;
            const name = document.getElementById("new-name").value;
            const description = document.getElementById("new-description").value;

            await fetch("/products/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sku, name, description })
            });

            hideCreateForm();
            fetchProducts();
        }

        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            await fetch(`/products/${id}`, { method: "DELETE" });
            fetchProducts();
        }

        fetchProducts();
    </script>

    <button onclick="bulkDelete()">Delete All Products</button>

    <script>
    async function bulkDelete() {
        if (!confirm("Are you sure? This cannot be undone.")) return;

        const response = await fetch("/products/", {
            method: "DELETE"
        });

        const result = await response.json();
        alert(result.detail);

        fetchProducts();
    }

    async function fetchProducts() {
        const response = await fetch("/products/");
        const products = await response.json();
        const table = document.getElementById("products-table-body");
        table.innerHTML = "";

        products.forEach(p => {
            const row = `<tr>
                <td>${p.id}</td>
                <td>${p.sku}</td>
                <td>${p.name}</td>
                <td>${p.description}</td>
                <td>${p.active}</td>
                <td>
                    <button onclick="editProduct(${p.id})">Edit</button>
                    <button onclick="deleteProduct(${p.id})">Delete</button>
                </td>
            </tr>`;
            table.innerHTML += row;
        });
    }
    </script>

</body>
</html>
